<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置状态检查 - 视频异常检测系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .status-good {
            border-left: 5px solid #28a745;
        }
        
        .status-warning {
            border-left: 5px solid #ffc107;
        }
        
        .status-error {
            border-left: 5px solid #dc3545;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .config-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="text-center mb-4">
                    <h1><i class="fas fa-cog me-2"></i>系统配置状态</h1>
                    <p class="text-muted">检查 Azure OpenAI 配置和系统状态</p>
                </div>
                
                <div id="status-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">检查中...</span>
                        </div>
                        <p class="mt-2">正在检查系统状态...</p>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="/" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>返回主页
                    </a>
                    <button class="btn btn-secondary ms-2" onclick="checkStatus()">
                        <i class="fas fa-sync me-2"></i>重新检查
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function checkStatus() {
            const container = document.getElementById('status-container');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">检查中...</span>
                    </div>
                    <p class="mt-2">正在检查系统状态...</p>
                </div>
            `;
            
            try {
                // 检查健康状态
                const healthResponse = await fetch('/health');
                const healthData = await healthResponse.json();
                
                // 测试 Azure 连接
                let azureStatus = null;
                try {
                    const azureResponse = await fetch('/test-connection');
                    azureStatus = await azureResponse.json();
                } catch (e) {
                    azureStatus = { success: false, error: e.message };
                }
                
                displayStatus(healthData, azureStatus);
                
            } catch (error) {
                container.innerHTML = `
                    <div class="status-card status-error">
                        <h4><i class="fas fa-exclamation-triangle me-2"></i>连接失败</h4>
                        <p>无法连接到应用程序: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function displayStatus(health, azure) {
            const container = document.getElementById('status-container');
            
            const overallStatus = health.status === 'healthy' && azure.success ? 'good' : 
                                health.status === 'degraded' ? 'warning' : 'error';
            
            const statusClass = `status-${overallStatus}`;
            const statusIcon = overallStatus === 'good' ? 'fa-check-circle text-success' :
                              overallStatus === 'warning' ? 'fa-exclamation-triangle text-warning' :
                              'fa-times-circle text-danger';
            
            container.innerHTML = `
                <div class="status-card ${statusClass}">
                    <h4><i class="fas ${statusIcon} me-2"></i>系统状态: ${getStatusText(overallStatus)}</h4>
                    <p class="text-muted">${health.message}</p>
                </div>
                
                <div class="status-card">
                    <h5><i class="fas fa-cog me-2"></i>配置检查</h5>
                    <div class="config-item">
                        <span>Azure OpenAI 端点</span>
                        <span>${getConfigStatus(health.configuration.azure_openai_endpoint)}</span>
                    </div>
                    <div class="config-item">
                        <span>Azure OpenAI API 密钥</span>
                        <span>${getConfigStatus(health.configuration.azure_openai_api_key)}</span>
                    </div>
                    <div class="config-item">
                        <span>Azure OpenAI 部署名称</span>
                        <span>${getConfigStatus(health.configuration.azure_openai_deployment)}</span>
                    </div>
                    <div class="config-item">
                        <span>AI 分析器初始化</span>
                        <span>${getConfigStatus(health.configuration.ai_analyzer_initialized)}</span>
                    </div>
                </div>
                
                <div class="status-card">
                    <h5><i class="fas fa-plug me-2"></i>Azure OpenAI 连接测试</h5>
                    ${azure.success ? `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>连接成功!
                            <br><small>模型: ${azure.model || 'N/A'}</small>
                            <br><small>响应: ${azure.response || 'N/A'}</small>
                        </div>
                    ` : `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>连接失败
                            <br><small>错误: ${azure.error}</small>
                            ${azure.help ? `<br><small>建议: ${azure.help}</small>` : ''}
                        </div>
                    `}
                </div>
                
                ${!azure.success || overallStatus !== 'good' ? `
                    <div class="status-card status-warning">
                        <h5><i class="fas fa-tools me-2"></i>配置指南</h5>
                        <p>请检查您的 .env 文件配置:</p>
                        <ol>
                            <li><strong>AZURE_OPENAI_ENDPOINT</strong>: 您的 Azure OpenAI 资源端点<br>
                                <code>https://your-resource-name.openai.azure.com/</code></li>
                            <li><strong>AZURE_OPENAI_API_KEY</strong>: 在 Azure 门户获取 API 密钥</li>
                            <li><strong>AZURE_OPENAI_DEPLOYMENT_NAME</strong>: GPT-4V 部署名称<br>
                                <code>gpt-4-vision-preview</code></li>
                        </ol>
                        <div class="mt-3">
                            <a href="/.env.example" class="btn btn-outline-primary btn-sm me-2" target="_blank">
                                <i class="fas fa-file-alt me-1"></i>查看配置模板
                            </a>
                            <button class="btn btn-outline-secondary btn-sm" onclick="showConfigHelp()">
                                <i class="fas fa-question-circle me-1"></i>配置帮助
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'good': return '正常';
                case 'warning': return '配置不完整';
                case 'error': return '错误';
                default: return '未知';
            }
        }
        
        function getConfigStatus(configured) {
            return configured ? 
                '<i class="fas fa-check-circle text-success"></i> 已配置' :
                '<i class="fas fa-times-circle text-danger"></i> 未配置';
        }
        
        function showConfigHelp() {
            alert(
                '配置步骤:\\n\\n' +
                '1. 复制 .env.example 为 .env\\n' +
                '2. 在 Azure 门户创建 OpenAI 资源\\n' +
                '3. 部署 GPT-4V 模型\\n' +
                '4. 获取端点和 API 密钥\\n' +
                '5. 更新 .env 文件中的配置\\n' +
                '6. 重启应用程序'
            );
        }
        
        // 页面加载时自动检查
        document.addEventListener('DOMContentLoaded', checkStatus);
    </script>
</body>
</html>