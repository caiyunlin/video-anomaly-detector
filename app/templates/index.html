<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Anomaly Detection - Azure AI Foundry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0078d4;
            --secondary-color: #106ebe;
            --success-color: #107c10;
            --warning-color: #ffaa44;
            --danger-color: #d13438;
            --bg-light: #f8f9fa;
        }

        body {
            background: linear-gradient(135deg, var(--bg-light) 0%, #e3f2fd 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .upload-zone {
            border: 3px dashed var(--primary-color);
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            margin-bottom: 2rem;
        }

        .upload-zone:hover {
            border-color: var(--secondary-color);
            background-color: #f0f8ff;
        }

        .upload-zone.dragover {
            border-color: var(--success-color);
            background-color: #e8f5e8;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
        }

        .analysis-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--primary-color);
        }

        .anomaly-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            margin: 10px 0;
        }

        .anomaly-detected {
            background-color: #ffe6e6;
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
        }

        .anomaly-normal {
            background-color: #e6ffe6;
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .confidence-bar {
            height: 25px;
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.8s ease;
        }

        .loading {
            display: none;
        }

        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color);
        }

        .video-info {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .footer {
            background-color: #343a40;
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 4rem;
        }

        .prompt-input {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 15px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .prompt-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 120, 212, 0.25);
        }

        @media (max-width: 768px) {
            .upload-zone {
                padding: 2rem 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="display-4 mb-0">
                <i class="fas fa-video me-3"></i>
                Video Anomaly Detection System
            </h1>
            <p class="lead mb-0">AI-powered surveillance video analysis based on Azure AI Foundry</p>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- Upload Form -->
                <div class="card shadow">
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <!-- Anomaly Prompt Input -->
                            <div class="mb-4">
                                <label for="anomalyPrompt" class="form-label">
                                    <i class="fas fa-search me-2"></i>
                                    <strong>Anomaly Detection Instructions</strong>
                                </label>
                                <textarea 
                                    class="form-control prompt-input" 
                                    id="anomalyPrompt" 
                                    name="anomaly_prompt" 
                                    rows="3" 
                                    placeholder="Describe the types of anomalies you want to detect, for example:&#10;• Person falling or tripping&#10;• Suspicious behavior or violence&#10;• Fire or smoke&#10;• Intruders or unauthorized personnel&#10;• Equipment malfunction or abnormal status&#10;• Traffic violations or accidents"
                                    required></textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Detailed descriptions help improve detection accuracy
                                </div>
                            </div>

                            <!-- Video Upload -->
                            <div class="upload-zone" id="uploadZone">
                                <i class="fas fa-cloud-upload-alt fa-4x mb-3 text-primary"></i>
                                <h4>Drag video files here or click to select files</h4>
                                <p class="text-muted mb-3">Supports MP4, AVI, MOV, MKV, WEBM formats</p>
                                <p class="text-muted">Maximum file size: 50MB</p>
                                <input type="file" id="videoFile" name="video" accept="video/*" style="display: none;">
                                <button type="button" class="btn btn-primary btn-lg" id="selectFileBtn">
                                    <i class="fas fa-folder-open me-2"></i>
                                    Select Video File
                                </button>
                            </div>

                            <!-- Selected File Display -->
                            <div id="selectedFile" style="display: none;" class="alert alert-info">
                                <i class="fas fa-file-video me-2"></i>
                                Selected: <span id="fileName"></span>
                            </div>

                            <!-- Submit Button -->
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="fas fa-play me-2"></i>
                                    Start Analysis
                                </button>
                            </div>
                        </form>

                        <!-- Loading State -->
                        <div id="loadingState" class="loading text-center py-5">
                            <div class="spinner-border spinner-border-custom mb-3" role="status">
                                <span class="visually-hidden">Analyzing...</span>
                            </div>
                            <h5>Analyzing video...</h5>
                            <p class="text-muted">This may take a few minutes, please wait patiently</p>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div id="results" style="display: none;">
                    <!-- Video Information -->
                    <div class="analysis-card">
                        <h5 class="mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Video Information
                        </h5>
                        <div class="video-info" id="videoInfo">
                            <!-- Video info will be populated here -->
                        </div>
                    </div>

                    <!-- Analysis Results -->
                    <div class="analysis-card">
                        <h5 class="mb-3">
                            <i class="fas fa-chart-line me-2"></i>
                            Analysis Results
                        </h5>
                        
                        <div id="analysisContent">
                            <!-- Analysis content will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="errorAlert" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <p>&copy; 2024 Video Anomaly Detection System | Powered by Azure AI Foundry</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM elements
        const uploadForm = document.getElementById('uploadForm');
        const uploadZone = document.getElementById('uploadZone');
        const videoFile = document.getElementById('videoFile');
        const selectedFile = document.getElementById('selectedFile');
        const fileName = document.getElementById('fileName');
        const submitBtn = document.getElementById('submitBtn');
        const loadingState = document.getElementById('loadingState');
        const results = document.getElementById('results');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        const videoInfo = document.getElementById('videoInfo');
        const analysisContent = document.getElementById('analysisContent');

        // File upload handling
        uploadZone.addEventListener('click', (event) => {
            // Only trigger when clicking upload area but not the button
            if (event.target === uploadZone || (event.target.closest('.upload-zone') && !event.target.closest('#selectFileBtn'))) {
                videoFile.click();
            }
        });

        // Add separate event listener for the button
        document.getElementById('selectFileBtn').addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent event bubbling
            videoFile.click();
        });

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                videoFile.files = files;
                handleFileSelection();
            }
        });

        videoFile.addEventListener('change', handleFileSelection);

        function handleFileSelection() {
            const file = videoFile.files[0];
            if (file) {
                fileName.textContent = file.name;
                selectedFile.style.display = 'block';
                
                // Validate file type
                const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime', 'video/x-msvideo', 'video/x-matroska', 'video/webm'];
                if (!allowedTypes.includes(file.type)) {
                    showError('Unsupported file format. Please upload MP4, AVI, MOV, MKV or WEBM video files.');
                    return;
                }
                
                // Validate file size (50MB)
                if (file.size > 50 * 1024 * 1024) {
                    showError('File too large. Please select a video file smaller than 50MB.');
                    return;
                }
                
                hideError();
            }
        }

        // Form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const anomalyPrompt = document.getElementById('anomalyPrompt').value.trim();
            const file = videoFile.files[0];
            
            if (!anomalyPrompt) {
                showError('Please enter anomaly detection instructions');
                return;
            }
            
            if (!file) {
                showError('Please select a video file');
                return;
            }
            
            // Show loading state
            showLoading();
            
            // Prepare form data
            const formData = new FormData();
            formData.append('video', file);
            formData.append('anomaly_prompt', anomalyPrompt);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    showError(data.error || 'Analysis failed, please try again');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        function showLoading() {
            uploadForm.style.display = 'none';
            loadingState.style.display = 'block';
            results.style.display = 'none';
            hideError();
        }

        function hideLoading() {
            uploadForm.style.display = 'block';
            loadingState.style.display = 'none';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.style.display = 'block';
            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideError() {
            errorAlert.style.display = 'none';
        }

        function displayResults(data) {
            hideError();
            
            // Display video information
            const vInfo = data.video_info;
            videoInfo.innerHTML = `
                <div class="info-item">
                    <strong>Total Frames:</strong>
                    <span>${vInfo.total_frames}</span>
                </div>
                <div class="info-item">
                    <strong>Frame Rate:</strong>
                    <span>${vInfo.fps.toFixed(2)} FPS</span>
                </div>
                <div class="info-item">
                    <strong>Duration:</strong>
                    <span>${vInfo.duration.toFixed(2)} seconds</span>
                </div>
                <div class="info-item">
                    <strong>Analyzed Frames:</strong>
                    <span>${vInfo.extracted_frames}</span>
                </div>
                <div class="info-item">
                    <strong>Detection Instructions:</strong>
                    <span>${data.prompt_used}</span>
                </div>
            `;
            
            // Display analysis results
            const analysis = data.analysis;
            const hasAnomaly = analysis.has_anomaly;
            const confidence = (analysis.confidence_score * 100).toFixed(1);
            
            let confidenceClass = 'bg-success';
            if (hasAnomaly) {
                confidenceClass = confidence > 70 ? 'bg-danger' : 'bg-warning';
            }
            
            analysisContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="anomaly-badge ${hasAnomaly ? 'anomaly-detected' : 'anomaly-normal'}">
                            <i class="fas ${hasAnomaly ? 'fa-exclamation-triangle' : 'fa-check-circle'} me-2"></i>
                            ${hasAnomaly ? 'Anomaly Detected' : 'No Anomaly Detected'}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <strong>Confidence: ${confidence}%</strong>
                        <div class="confidence-bar">
                            <div class="confidence-fill ${confidenceClass}" style="width: ${confidence}%"></div>
                        </div>
                    </div>
                </div>
                
                ${analysis.anomaly_type ? `
                <div class="mt-3">
                    <strong>Anomaly Type:</strong>
                    <p class="mb-2">${analysis.anomaly_type}</p>
                </div>
                ` : ''}
                
                ${analysis.detected_frames && analysis.detected_frames.length > 0 ? `
                <div class="mt-3">
                    <strong>Detected Anomaly Frames:</strong>
                    <p class="mb-2">${analysis.detected_frames.join(', ')}</p>
                </div>
                ` : ''}
                
                ${analysis.timestamps && analysis.timestamps.length > 0 ? `
                <div class="mt-3">
                    <strong>Anomaly Timestamps:</strong>
                    <p class="mb-2">${analysis.timestamps.map(t => t.toFixed(2) + 's').join(', ')}</p>
                </div>
                ` : ''}
                
                <div class="mt-3">
                    <strong>Detailed Description:</strong>
                    <p class="mb-2">${analysis.description}</p>
                </div>
                
                ${analysis.recommendations ? `
                <div class="mt-3">
                    <strong>Recommended Actions:</strong>
                    <p class="mb-2">${analysis.recommendations}</p>
                </div>
                ` : ''}
                
                ${analysis.error ? `
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${analysis.error}
                </div>
                ` : ''}
            `;
            
            results.style.display = 'block';
            results.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Reset form function
        function resetForm() {
            uploadForm.reset();
            selectedFile.style.display = 'none';
            results.style.display = 'none';
            hideError();
        }

        // Add reset button functionality
        const resetBtn = document.createElement('button');
        resetBtn.type = 'button';
        resetBtn.className = 'btn btn-outline-secondary ms-3';
        resetBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Analyze Again';
        resetBtn.onclick = resetForm;
        
        // Add reset button next to submit button
        submitBtn.parentElement.appendChild(resetBtn);
    </script>
</body>
</html>